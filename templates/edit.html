{% extends "base.html" %}
{% block title %}{{ config['APP_TITLE'] }}{% endblock %}
{% block head %}
  {{ super() }}

{% endblock %}
{% block content %}

    <h2> Editing {{spreadsheet_name}} </h2>

<div class="row">
    <div class="col-md-4">
        <button id=add-row>Add Row</button>
    </div>
    <div class="col-md-4">
        <button id=delete-row>Delete Row</button>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
    <div id="contentTable" class="table table-bordered table-hover table-sm">
    </div>
    </div>
</div>

{% endblock %}

{% block javascriptblock %}
<!-- //tabulator: -->

<link href="https://unpkg.com/tabulator-tables@4.8.2/dist/css/tabulator_simple.min.css" rel="stylesheet">

<script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.8.2/dist/js/tabulator.min.js"></script>


<script type="text/javascript">
    // Column name for curation status
    var curation_status = "Curation status"

    // For the curation status, the allowed values
    var discussed = "Discussed";
    var ready = "Ready";
    var proposed = "Proposed";


    //Get the row data from the Jinja template object "rows"
    var rowData = {{ rows | safe }};
    var rowLength = rowData.length;

    var headers = {{ header | safe }};
    var headerLength = headers.length;

    //Build the table row data with field names
    var tableData = [];
    for (var i=0; i<rowLength; i++) {
        var rowObj = {id:i}
        for (var j=0; j<headerLength; j++) {
            rowObj[ headers[j] ] = rowData[i][ headers[j] ];
        }
        tableData.push(rowObj);
    }

    //Build the column data from the Jinja template object "header"
    var columnData = []; //Start with an empty array
    for (var i=0; i<headerLength; i++) {
        //Dropdown list for "Curation status":
        //Todo: do I need to sanitize this? Need to support "Curation Status", "CurationStatus"?
        if(headers[i] == "Curation status"){
            columnData.push({title:headers[i], field:headers[i], editor: "select", editable:true, editorParams:{values:["Proposed", "Discussed", "Ready"]}, headerFilter:"input", width:"200", formatter:"textarea"});

        } else{
            columnData.push({title:headers[i], field:headers[i], editor: "input", editable:true, headerFilter:"input", width:"200", formatter:"textarea"});
        }
    }

    //Create the Tabulator table:
    var table = new Tabulator("#contentTable", {
        //  tooltips:true, //example option (enable tooltips on all cells)
        // autoColumns:true
        // columns: tableDataArray, //definitely not working right now..
        groupToggleElement:"header",
        height:600,
        // height:"100%",
        layout:"fitColumns",
        // pagination:"local",
        // paginationSize:"20",
        movableRows:false,
        groupBy:"Id",
        groupStartOpen:true,
        persistence:true,
        // width:200, //invalid option
        // virtualDomHoz:true, //not working
        // persistentLayout: true, //depreciated, using persistence
        // persistentLayoutID:"spreaded", //depreciated, using persistence
        // movableRows:true,
        // responsiveLayout:"hide",

        addRowPos:"bottom",
        // virtualDom:false,
        data: tableData,
        columns: columnData,
         
        
        rowSelected:function(row){
            row.getElement().style.backgroundColor = 'blue';
        },
        rowDeselected:function(row){
            row.getElement().style.backgroundColor = 'white';
        }, 
        // rowClick:function(e, row){ //trigger an alert message when the row is clicked
        // 	alert("Row " + row.getData().id + " Clicked!!!!");
        // },

        //cellClick:function(e, cell){
            // console.log(cell.getValue()); //this works
            //e - the click event object
            //cell - cell component
        //},
        cellEditing:function(cell){
            //todo: if row is selected (by clicking in a cell), clicking in the same cell does nothing 
            var row = cell.getRow();
            row.toggleSelect();
        },

        cellEdited:function(cell){
            cell.getElement().style.color = "#A6A6DF"; //ok this works!
            var row = cell.getRow();
            var data = row.getData();
            if (data[curation_status] !== null) {
                if(data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(discussed.toLowerCase()) !== -1){
                    row.getElement().style.backgroundColor = 'moccasin'; //apply css change to row element
                }
                if(data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(ready.toLowerCase()) !== -1){
                    row.getElement().style.backgroundColor = 'palegreen'; //apply css change to row element
                }
                if(data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(proposed.toLowerCase()) !== -1){
                    row.getElement().style.backgroundColor = 'white'; //apply css change to row element
                }
            }
        },

        //highlight on load table:
        rowFormatter:function(row){
            var data = row.getData();
            if (data[curation_status] !== null) {
                if(data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(discussed.toLowerCase()) !== -1){
                    row.getElement().style.backgroundColor = 'moccasin'; //apply css change to row element
                }
                if(data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(ready.toLowerCase()) !== -1){
                    row.getElement().style.backgroundColor = 'palegreen'; //apply css change to row element
                }
                if(data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(proposed.toLowerCase()) !== -1){
                    row.getElement().style.backgroundColor = 'white'; //apply css change to row element
                }
            }
        },

        // rowUpdated:function(row){
        //is this for when row is updated on the back end?
        // },
    });

    //new row button click handler:
    $("#add-row").click(function(){
        var newRowData = {};
        newRowData[curation_status] = "Proposed"
        table.addRow(newRowData);
    });

//delete row button click handler:
//todo: this needs a lot of work, how does the tabulator selection stack work?
   $("#delete-row").click(function(){
    {# table.deleteRow({curation_status:"Proposed "}); #}
    var selectedRows = table.getSelectedRows();
    {# var selectedData = table.getSelectedData(); #}
                if (confirm("Do you really want to delete this row?")) {
                    table.deleteRow(selectedRows); //warning: this deletes all previously selected rows!
                } else {
                    //nothing
                    //todo: change row background colour back to white here
                }
    });

    $('#contentTable').ready(function() {
    });

</script>

{% endblock %}
