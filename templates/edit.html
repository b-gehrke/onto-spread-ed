{% extends "base.html" %}
{% block title %}{{ config['APP_TITLE'] }}{% endblock %}
{% block head %}
  {{ super() }}

{% endblock %}
{% block content %}

<div class="row mb-3">
    <div class="col-md-12">
        <h2> Editing {{spreadsheet_name}} </h2>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-9">
        <button id=add-row class="btn btn-outline-secondary"><i class="fas fa-plus"></i> Add Row</button>
        <button id=delete-row class="btn btn-outline-secondary"><i class="fas fa-trash-alt"></i> Delete Row</button>
         <!-- //todo: highlight-user button same colour as row highlight colour? -->
        <button id=highlight-user class="btn btn-outline-secondary"><i class="fas fa-highlighter"></i> Highlight Your Rows</button>
    </div>

    <div class="col-md-3">
        <button id="save-btn" class="btn btn-outline-success" onclick="save_changes( '{{repo_name}}', '{{folder}}' , '{{ spreadsheet_name }}' , table.getData() ) "> Save changes to repository
        </button>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <div id="contentTable" class="table table-bordered table-hover table-sm" style="font-size: 0.8em;">
    </div>
    </div>
</div>


<div class="row">
<!-- The form that gets displayed on the confirmation box, otherwise is hidden -->
  <div id="message-box" class="form-content" style="display:none;">
      <form class="form" role="form">
          <div class="form-group">
            <label for="commit-msg">Commit message</label>
            <input type="text" class="form-control" id="commit-msg" name="commit-msg">
          </div>
          <div class="form-group">
            <label for="descr">Detailed description</label>
            <input type="text" class="form-control" id="descr" name="descr">
          </div>
      </form>
  </div>
</div>


{% endblock %}

{% block javascriptblock %}
<!-- //tabulator: -->

<link href="https://unpkg.com/tabulator-tables@4.8.2/dist/css/tabulator_simple.min.css" rel="stylesheet">
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.8.2/dist/js/tabulator.min.js"></script>

<!-- bootstrap 4 theme -->
<link href="https://unpkg.com/tabulator-tables@4.8.2/dist/css/bootstrap/tabulator_bootstrap4.min.css" rel="stylesheet">


<script type="text/javascript">
    // Column name for curation status
    var curation_status = "Curation status"

    // For the curation status, the allowed values
    var discussed = "Discussed";
    var ready = "Ready";
    var proposed = "Proposed";

    //Column name for Proposer
    var proposer = "Proposer";

    //Get the row data from the Jinja template object "rows"
    var rowData = {{ rows | safe }};
    var rowLength = rowData.length;

    var headers = {{ header | safe }};
    var headerLength = headers.length;

    //Build the table row data with field names
    var tableData = [];
    for (var i=0; i<rowLength; i++) {
        var rowObj = {id:i}
        for (var j=0; j<headerLength; j++) {
            rowObj[ headers[j] ] = rowData[i][ headers[j] ];
        }
        tableData.push(rowObj);


    }



    //todo: do we need to build fields array - I read that fields need to be lowercase without spaces for parts of Tabulator to work
    //var fields = [];
    //for (var k=0; k<headerLength; k++) {
    //    fields.push(headers[k].toLowerCase().replace(/\s+/g, ''));
    //}

    //login

    var loginName = "{{login}}";
    var highlightLogin = false; //highlight user edited tables


    //header menu:
    //define row context menu
    //todo: resize to header text or initial value per header?
var headerMenu = [
    {
        label:"Hide Column",
        action:function(e, column){
            column.setWidth(30);
        }
    },
    {
        label:"Show Column",
        action:function(e, column){
            column.setWidth(200);
        }
    },
]

    //Build the column data from the Jinja template object "header"
    var columnData = []; //Start with an empty array
    //checkbox row selector on the side:
    columnData.push({formatter:"rowSelection", titleFormatter:"rowSelection", width:"50", hozAlign:"center", headerSort:false});
    for (var i=0; i<headerLength; i++) {
        //Dropdown list for "Curation status":
        //Todo: do I need to sanitize this? Need to support "Curation Status", "CurationStatus"?
        if(headers[i] == "Curation status"){
            columnData.push({title:headers[i], field:headers[i], editor: "select", editable:true, editorParams:{values:["Proposed", "Discussed", "Ready"]}, headerFilter:"input", width:"200", formatter:"textarea", headerMenu:headerMenu});
        } else if(headers[i] == "E-CigO"){ //todo: headerFilter can't select by unchecked?
            columnData.push({title:headers[i], field:headers[i], hozAlign:"center", editor:true, formatter:"tickCross", headerFilter:true, width:"50", headerMenu:headerMenu});
        }else if(headers[i] == "Fuzzy set"){
            columnData.push({title:headers[i], field:headers[i], hozAlign:"center", editor:true, formatter:"tickCross", headerFilter:true, width:"50", headerMenu:headerMenu});
        }
        //"Proposer" column should not be edited directly
        else if(headers[i] == "Proposer"){
            columnData.push({title:headers[i], field:headers[i], headerFilter:"input", width:"200", formatter:"textarea", headerMenu:headerMenu});
        }
        else{
            columnData.push({title:headers[i], field:headers[i], editor: "input", editable:true, headerFilter:"input", width:"200", formatter:"textarea", headerMenu:headerMenu});
        }
    }

    //Create the Tabulator table:
    var table = new Tabulator("#contentTable", {
        // tooltips:true, //example option (enable tooltips on all cells)
        groupToggleElement:"header",
        height:600,
        //height:"100%", //this makes the header not stay on the top..
        layout:"fitColumns",
        // pagination:"local",
        // paginationSize:"20",
        movableRows:false,
        groupBy:"Id",
        groupStartOpen:true,
        persistence:true,  //todo: add reset all functionality (button?), in case table is put in unusable state by user (very possible based on experience)
        // movableRows:true,
        // responsiveLayout:"hide",
        keybindings:true,
        history:true, //records table interaction
        addRowPos:"bottom",
        // virtualDom:false,
        data: tableData,
        columns: columnData,
        reactiveData:true, //enables updating cell contents programmatically

        //todo: select all checkbox doesn't trigger rowSelected (no highlight, still deletes though...) - maybe it's just slow?
        rowSelected:function(row){
            row.getElement().style.backgroundColor = 'grey';
        },
        rowDeselected:function(row){
            row.getElement().style.backgroundColor = 'white';
        },
        // rowClick:function(e, row){ //trigger an alert message when the row is clicked
        // 	alert("Row " + row.getData().id + " Clicked!!!!");
        // },

        //cellClick:function(e, cell){
            // console.log(cell.getValue()); //this works
            //e - the click event object
            //cell - cell component
        //},
        cellEditing:function(cell){
            //now using check box to select rows
            //var row = cell.getRow();
            //row.toggleSelect();
        },

        cellEdited:function(cell){
            cell.getElement().style.color = "#003399"; //change text colour on edited!
            var row = cell.getRow();
            var data = row.getData();
            var column = cell.getColumn();
            //var pos = row.getPosition(true); //row position from top, todo: is this needed?

            //update highlighting:
            if (data[curation_status] !== null) {
                if(data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(discussed.toLowerCase()) !== -1){
                    row.getElement().style.backgroundColor = 'moccasin'; //apply css change to row element
                }
                if(data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(ready.toLowerCase()) !== -1){
                    row.getElement().style.backgroundColor = 'palegreen'; //apply css change to row element
                }
                if(data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(proposed.toLowerCase()) !== -1){
                    row.getElement().style.backgroundColor = 'white'; //apply css change to row element
                }
            }

            //proposer column - check for loginName and auto fill:
                if(data[proposer] !== null){
                    var prevProposer = data[proposer];
                    var nameCheck = prevProposer.indexOf(loginName);
                    if(nameCheck > -1) {
                        //name exists, don't update
                    } else {
                        data[proposer] = prevProposer + "; " + loginName;
                    }
                } else{
                    data[proposer] = loginName;
                }

                //text must be coloured if highlighting login set though..
                if(highlightLogin){
                    if(data[proposer] !== null){
                        var proposerA = data[proposer];
                        if(proposerA !== null){
                            var nameCheckA = proposerA.indexOf(loginName);
                            if(nameCheckA > -1) {
                                row.getElement().style.color = 'red';
                            }
                        }
                    }
            }
                //table.redraw(true); //not needed - redraws the whole table
                    //console.log("tableData Proposer is: "  + data[proposer]);
                    //todo: investigate the difference in tabulator between data[proposer] and tableData[pos].Proposer
                    //todo: is this going to affect saving the table?
        },

        //highlight on load table:
        rowFormatter:function(row){
            var data = row.getData();

                if (data[curation_status] !== null) {
                    if(data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(discussed.toLowerCase()) !== -1){
                        row.getElement().style.backgroundColor = 'moccasin'; //apply css change to row element
                    }
                    if(data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(ready.toLowerCase()) !== -1){
                        row.getElement().style.backgroundColor = 'palegreen'; //apply css change to row element
                    }
                    if(data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(proposed.toLowerCase()) !== -1){
                        row.getElement().style.backgroundColor = 'white'; //apply css change to row element
                    }
                }

            if(highlightLogin){
                if(data[proposer] !== null){
                    var proposerA = data[proposer];
                    var nameCheckA = proposerA.indexOf(loginName);
                    if(nameCheckA > -1) {
                        row.getElement().style.color = 'red';
                    }
                }
            } else{
                    row.getElement().style.color = 'black';
                }
        },

        // rowUpdated:function(row){
        //is this for when row is updated on the back end?
        // },
    });

    //new row button click handler:
    $("#add-row").click(function(){
        var newRowData = {};
        newRowData[curation_status] = "Proposed";
        // todo: if newRowData[proposer] isn't defined here there is a bug. Uncaught typerror Cannot read property 'indexOf' of undefined
        newRowData[proposer] = loginName;  // if we don't want this, maybe use " " instead?
        table.addRow(newRowData);
    });

    //delete row button click handler:
    //todo: additional functionality needed:
    // 1. if more than one row to be deleted, dialog says "Do you really want to delete these " + numberOfRowsSelected + "rows"
    // 2. if no rows selected, dialog says "No rows selected" and returns
    $("#delete-row").click(function(){
        var selectedRows = table.getSelectedRows();
        if (confirm("Do you really want to delete this row?")) {
            table.deleteRow(selectedRows);
        } else {
            //nothing
        }
    });

    $("#highlight-user").click(function(){
        highlightLogin = !highlightLogin;
        if(highlightLogin){
            this.children[0].style.color = "#FF0000";
        } else{
            this.children[0].style.color = "#333300";
        }
        table.redraw(true);
    });

    $('#contentTable').ready(function() {
    });




    /**
    * Submit a pull request to github to update the given configuration file in the repository.
    */
    var save_changes = function(repo_key, folder, spreadsheet, rowData) {
    $("#commit-msg").attr('value','Updating ' + spreadsheet);

    // Get a confirmation from the user:
    var modal = bootbox.dialog({
        title: "You are about to submit changes. Please describe the changes you have made to " + spreadsheet,
        message: $("#message-box").html(),
        buttons: {
        confirm: {
            label: 'Submit',
            className: 'btn-danger',
            callback: function() {
                var aForm = modal.find(".form");
                var formData = aForm.serializeArray(),
                    dataObj = {};
                $(formData).each(function(i, field){
                dataObj[field.name] = field.value;
                });
                var commit_msg = dataObj["commit-msg"];
                var msgBody = dataObj["descr"];
                if (commit_msg !== null && commit_msg !== undefined) {
                    if (!commit_msg || commit_msg.trim() === "") {
                    bootbox.alert({
                        closeButton: false,
                        message: "Commit message cannot be empty. Your change has not been submitted."});
                    return;
                    }

                    // Embed the code into a request.
                    var request = new XMLHttpRequest();
                    // Define a function to handle a state change of the request:
                    request.onreadystatechange = function() {
                    $("*").css("cursor", "default");
                    if (request.readyState === 4) {
                        if (!request.status) {
                            alert("Problem communicating with server");
                        }
                        else if (request.status === 200) {
                          //var response = JSON.parse(request.responseText);
                          //var prInfo = response['pr_info'];
                          //alert('Update submitted successfully. The changes will be ' +
                          //    'reviewed by a moderator before being added to the repository. Click ' +
                          //    '<a href="' + prInfo['html_url'] + '" target="__blank">here</a> to view your ' +
                          //    'pull request on GitHub.');
                            alert("Updated submitted successfully");
                        } else {
                            alert("Submission of update failed.");
                        }
                    }
                    }
                    // Post the request to the server.
                    request.open('POST', '/save', true);
                    request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                    request.send('repo_key=' + repo_key +
                                '&folder=' + folder +
                                '&spreadsheet=' + spreadsheet +
                                '&rowData=' + rowData +
                                '&commit_msg=' + commit_msg);
                    $("*").css("cursor", "progress");
            }
            }
        },
        cancel: {
            label: 'Cancel',
            className: 'btn-primary'
        }
        }
    });
    };



</script>

{% endblock %}
