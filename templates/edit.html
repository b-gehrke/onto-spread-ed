{% extends "base.html" %}
{% block title %}{{ config['APP_TITLE'] }}{% endblock %}
{% block head %}
{{ super() }}

{% endblock %}
{% block content %}

<div class="row mb-3">
    <div class="col-md-12">
        <h2 id="s-name"> Editing {{spreadsheet_name}} </h2>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-9">
        <div class="text-left">
            <button id=add-row class="btn btn-outline-info btn-sm"><i class="fas fa-plus"></i> Add Row</button>
            <button id=delete-rows class="btn btn-outline-danger btn-sm"><i class="fas fa-trash-alt"></i> Delete
                Rows</button>
            <button id=highlight-user class="btn btn-outline-warning btn-sm"><i class="fas fa-highlighter"></i>
                Highlight Your Rows</button>
            <button id=remove-formatting class="btn btn-outline-dark btn-sm"><i class="fas fa-remove-format"></i> Remove
                all Filters</button>
            <button id=ask-for-review class="btn btn-outline-primary btn-sm"><i class="fas fa-clipboard"></i> Ask for
                review</button>
            <button id=reviewed class="btn btn-outline-primary btn-sm"><i class="fas fa-clipboard-check"></i>
                Reviewed</button>
        </div>
    </div>
    <!-- onclick="save_changes( '{{repo_name}}', '{{folder}}' , '{{ spreadsheet_name }}' , JSON.stringify( table.getData() ) ) "> -->
    <div class="col-md-3">
        <button id="save-btn" class="btn btn-outline-success btn-sm"
            onclick="save_changes( '{{repo_name}}', '{{folder}}' , '{{ spreadsheet_name }}' , JSON.stringify( table.getData() ), JSON.stringify( testTableData ), 'false' ) ">
            Save changes to repository
        </button>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <div id="saveAlert" class="alert alert-success collapse" role="alert">
            <button id="closeSaveMsgBtn" type="button" class="close" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            <div id="saveMessage"> </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <div id="contentTable" class="table table-bordered table-hover table-sm" style="font-size: 0.8em;">
        </div>
    </div>
</div>


<div class="row">
    <!-- The form that gets displayed on the confirmation box, otherwise is hidden -->
    <div id="message-box" class="form-content" style="display:none;">
        <form class="form" role="form">
            <div class="form-group">
                <label for="commit-msg">Commit message</label>
                <input type="text" class="form-control" id="commit-msg" name="commit-msg">
            </div>
            <div class="form-group">
                <label for="descr">Detailed description</label>
                <input type="text" class="form-control" id="descr" name="descr">
            </div>
        </form>
    </div>
</div>


{% endblock %}finish this dropdown and add button functionality

{% block javascriptblock %}
<!-- //tabulator: -->
<!-- always up-to-date tabulator CDN? -->
<link href="https://unpkg.com/tabulator-tables/dist/css/tabulator_simple.min.css" rel="stylesheet">
<script type="text/javascript" src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"></script>


<!-- bootstrap 4 theme -->
<link href="https://unpkg.com/tabulator-tables/dist/css/bootstrap/tabulator_bootstrap4.min.css" rel="stylesheet">

<script type="text/javascript">
    allCookies = document.cookie;
    console.log("allCookies: " + allCookies);

    var file_sha = '{{file_sha}}';
    var repo_name = '{{repo_name}}';
    //hide save button on load
    $('#save-btn').hide();



    // Column name for curation status
    var curation_status = "Curation status"
    var prevCurationStatus = "";
    // For the curation status, the allowed values
    var discussed = "Discussed";
    var ready = "Ready"; //removing this
    var proposed = "Proposed";
    var toBeDiscussed = "ToBeDiscussed";
    var inDiscussion = "InDiscussion";
    var published = "Published";
    var obsolete = "Obsolete";
    var external = "External";

    //whyFuzzy
    var why_Fuzzy = "Why fuzzy";//column name
    var whyFuzzy = "Whyfuzzy";

    //Fuzzy Set
    var fuzzy_Set = "Fuzzy set"; //column name

    //E-Cig0


    //for to be reviewed by
    var to_be_reviewed_by = "To be reviewed by";
    //Column name for Curator
    var curator = "Curator";

    var AOsub_ontology = "AO sub-ontology";

    // array to save changes in backupChanges
    var changes = [];

    //boolean conflict check
    var unsavedChanges = false;

    //Get the row data from the Jinja template object "rows"
    var rowData = {{ rows | safe }};
    var rowLength = rowData.length;

    var headers = {{ header | safe }};
    var headerLength = headers.length;


    //current spreadsheet name    
    var thisSheet = '{{spreadsheet_name | safe}}';
    console.log("thisSheet is: " + thisSheet);

    //Build the table row data with field names
    var tableData = [];
    var testTableData = [];

    //get saved table data, compare to current table:
    for (var i = 0; i < rowLength; i++) {
        var rowObj = { id: i }
        for (var j = 0; j < headerLength; j++) {
            rowObj[headers[j]] = rowData[i][headers[j]];
        }
        testTableData.push(rowObj);
    }

    //todo: save login name as well as sheet name?.
    var previousTableData = localStorage.getItem("savedTableData" + thisSheet);
    if (JSON.stringify(testTableData) === previousTableData) {
        console.log("SAME SAME");
    } else {
        try {
            unsavedChanges = true;
            console.log("NOT SAME WHY?");
            var changesArray = [];
            //check saved changes array
            if (window.localStorage.getItem("savedChanges" + thisSheet) !== null) {
                var previousChangeData = window.localStorage.getItem("savedChanges" + thisSheet);
                // console.log("previousChangeData is: " + previousChangeData); //just checking.
                changesArray = JSON.parse(previousChangeData);
                unsavedChanges = true;
                if (changesArray.length < 3) { //savedChanges not correct format or empty
                    window.localStorage.removeItem("savedChanges" + thisSheet);
                    unsavedChanges = false;
                }
            } else { //no saved changes, don't look for them later
                console.log("savedChanges missing");
                unsavedChanges = false;
                //remove previous table array
                window.localStorage.removeItem("savedTableData" + thisSheet); //is this necessary? 
            }
            var changesLength = changesArray.length / 3;
            var changeWorkingOn = 0;
        } catch (err) {
            console.log(err);
            unsavedChanges = true;
        }
    }


    // unsavedChanges = false; //un-comment this line to disable restoring backup functionality. 

    //restore unsaved changes if needed:
    try {
        if (unsavedChanges) {
            //build array of data which will be replaced: 
            var tableChangedArray = [];
            for (var i = 0; i < rowLength; i++) {
                var rowObj = { id: i }
                for (var j = 0; j < headerLength; j++) {
                    for (var a = 0; a < changesArray.length; a++) {
                        if (i == changesArray[a + 1]) { //row
                            if (headers[j] == changesArray[a + 2]) { //column
                                if (testTableData[i * j] == undefined || testTableData[i * j] == null) {
                                    tableChangedArray.push("");
                                } else {
                                    tableChangedArray.push(JSON.stringify(testTableData[i * j][changesArray[a + 2]]));
                                }
                            }
                        }
                    }
                }
            }

            var changedMessage = "";
            for (var i = 0; i < changesArray.length; i += 3) {
                if (tableChangedArray[i] == "null" || tableChangedArray[i] == undefined) {
                    changedMessage += "Row " + changesArray[i + 1] + ", " + changesArray[i + 2] + ": " + "\"\"" + "=>" + JSON.stringify(changesArray[i]) + "\n";
                } else {
                    changedMessage += "Row " + changesArray[i + 1] + ", " + changesArray[i + 2] + ": " + tableChangedArray[i] + "=>" + JSON.stringify(changesArray[i]) + "\n";
                }
            }

            /*
            //bootbox dialog - runs callback functions asynchronously, so not waiting for confirmation 
            //before loading the table. This is bad. todo: how to make bootbox dialog wait?
            
                        var dialog = bootbox.dialog({
                            title: "You have previously unsaved changes \n Press 'Yes' to keep them. \n",
                            message: changedMessage,
                            buttons: {
                                confirm: {
                                    label: 'Yes',
                                    className: 'btn-success',
                                    callback: function () {
                                        console.log('Custom confirm clicked');
                                        //unsavedChanges code here, plus save at end
                                        console.log("confirmed");
                                        //new method: restoring entire array:
                                        var newRowLength = previousTableData.length / headerLength;
                                        console.log(newRowLength);
                                        tableData = JSON.parse(previousTableData); //nope, its a string. Convert to array
                                        alert("Restored data is not permanent. \n Press save to keep your changes or they will be lost!");
                                        window.localStorage.removeItem("savedChanges" + thisSheet); //remove change array
                                        $('#save-btn').show();
                                        //todo: save automatically? Keep the changes? Add to change array instead of dealing with it now?
                                    }
                                },
                                cancel: {
                                    label: 'No',
                                    className: 'btn-danger',
                                    callback: function () {
                                        console.log('Custom cancel clicked');
                                        //discard changes
                                        for (var i = 0; i < rowLength; i++) {
                                            var rowObj = { id: i }
                                            for (var j = 0; j < headerLength; j++) {
                                                rowObj[headers[j]] = rowData[i][headers[j]];
                                            }
                                            tableData.push(rowObj);
                                        }
                                        window.localStorage.removeItem("savedChanges" + thisSheet); //remove change array
                                    }
                                }
                            }
                        });
            */
            if (confirm("You have previously unsaved changes \n Press 'OK' to keep them. \n" + changedMessage)) {
                //unsavedChanges code here, plus save at end
                console.log("confirmed");
                //Restoring entire array:
                var newRowLength = previousTableData.length / headerLength;
                console.log(newRowLength);
                tableData = JSON.parse(previousTableData); //nope, its a string. Convert to array
                //todo: below needs to block, but we want a bootbox style which is asynchronous?
                alert("Restored data is not permanent. \n Press save to keep your changes or they will be lost!");
                window.localStorage.removeItem("savedChanges" + thisSheet); //remove change array
                $('#save-btn').show();
                //todo: save automatically? Keep the changes? Add to change array instead of dealing with it now?
            } else {
                //discard changes 
                populateTable();
                window.localStorage.removeItem("savedChanges" + thisSheet); //remove change array
            }

        } else {
            //no saved changes
            populateTable();
        }
    } catch (err) {
        // alert("an error occurred, unable to restore unsaved changes\n" + err);
        window.localStorage.removeItem("savedChanges" + thisSheet); //remove change array
        //still build table, but losing changes on error, without any error message. 
        populateTable();
    }

    function populateTable() {
        for (var i = 0; i < rowLength; i++) {
            var rowObj = { id: i }
            for (var j = 0; j < headerLength; j++) {
                rowObj[headers[j]] = rowData[i][headers[j]];
                //trying to set null values to 0 in checkbox columns here:
                if (headers[j] == fuzzy_Set || headers[j] == "E-CigO") { //column
                    if (rowObj[headers[j]] == null) {
                        rowObj[headers[j]] = 0;
                    }
                    /////////////////////fix E-CigO removing ticks///////////////////////
                    if (rowObj[headers[j]] == 1) {
                        rowObj[headers[j]] = 1;
                    }
                    ////////////////////////////////////////////////////////////////////
                } else {
                    if (rowObj[headers[j]] == null) {
                        rowObj[headers[j]] = ""; //change all null to ""
                    }
                }
                //All rows with empty IDs --> not external. 
                //Rows with AddictO IDs in AddictO repo or BCIO IDs in BCIO repo --> not external. 
                //Only rows with  non-empty IDs, that are not matching the project ID template, are external.
                //adding "External" status 
                if (headers[j] == curation_status) { //column
                    console.log("repo_name is: " + repo_name);
                    if (rowObj["ID"] == undefined) {
                        //no "ID" column
                    } else {
                        if (rowObj["ID"] == "" || rowObj["ID"] == null) {
                            //not External
                        } else {
                            //different repo's: 
                            if (repo_name == "BCIO") {
                                //todo: is there no change for "" and null here as well? 
                                if (rowObj["ID"].includes("BCIO")) {
                                    //not external
                                } else {
                                    rowObj[headers[j]] = "External";
                                }
                            } else { //"AddictO repo"
                                if (rowObj["ID"].includes("ADDICTO")) {
                                    //not external
                                } else {
                                    rowObj[headers[j]] = "External";
                                }
                            }
                        }
                    }


                }
            }
            tableData.push(rowObj);
        }
    }

    //login
    var loginInitials = "{{user_initials}}";
    var highlightLogin = false; //highlight user edited tables

    //all_initials
    var allInitials = {{ all_initials | safe }};
    console.log("allInitials: " + allInitials);

    // save changes
    var tableEdited = false; //true when user has unsaved changes - for exit without saving warning

    //row value, keep track of where we are:
    var rowValue = 0;
    var columnValue = 0; //why doesn't tabulator have this

    //header menu:
    //define row context menu
    //todo: resize to header text or initial value per header?
    var headerMenu = [
        {
            label: "Hide Column",
            action: function (e, column) {
                column.hide();
            }
        },
        {
            label: "Show Hidden",
            action: function (e, column) {
                var allColumns = table.getColumns();
                for (var i = 0; i < allColumns.length; i++) {
                    if (!table.getColumn(allColumns[i]).isVisible()) {
                        table.getColumn(allColumns[i]).show();
                    }
                }
            }
        },
        {
            label: "Reset All Column Widths",
            action: function (e, column) {
                var allColumns = table.getColumns();
                for (var i = 1; i < allColumns.length; i++) { //don't re-size checkbox column (column 0)
                    //"E-CigO" and "Fuzzy set" are a different size
                    if (table.getColumn(allColumns[i]).getField() == "E-CigO" || table.getColumn(allColumns[i]).getField() == "Fuzzy set") {
                        table.getColumn(allColumns[i]).setWidth(140);
                    } else {
                        table.getColumn(allColumns[i]).setWidth(200);
                    }
                }
            }
        },
    ]

    //Build the column data from the Jinja template object "header"
    var columnData = []; //Start with an empty array
    //checkbox row selector on the side:
    columnData.push({ title: "Selector", formatter: "rowSelection", titleFormatter: "rowSelection", width: "50", hozAlign: "center", headerSort: false, frozen: true });
    for (var i = 0; i < headerLength; i++) {
        //Dropdown list for "Curation status":
        if (headers[i] == "Curation status") {
            columnData.push({ title: headers[i], field: headers[i], sorter: "string", editor: "select", editable: true, editorParams: { values: ["Proposed", "To Be Discussed", "In Discussion", "Discussed", "Published", "Obsolete"] }, headerFilter: "input", width: "200", formatter: "textarea", headerMenu: headerMenu });
        } else if (headers[i] == "E-CigO") {
            columnData.push({ title: headers[i], field: headers[i], sorter: "boolean", hozAlign: "center", editor: true, formatter: "tickCross", headerFilter: true, width: "140", headerMenu: headerMenu });
        } else if (headers[i] == "Fuzzy set") {
            columnData.push({ title: headers[i], field: headers[i], sorter: "boolean", hozAlign: "center", editor: true, formatter: "tickCross", headerFilter: true, width: "140", headerMenu: headerMenu });
        }
        else if (headers[i] == "To be reviewed by") {
            columnData.push({ title: headers[i], field: headers[i], sorter: "string", editor: "textarea", editable: true, headerFilter: "input", width: "200", formatter: "textarea", headerMenu: headerMenu });
        }
        else {
            columnData.push({ title: headers[i], field: headers[i], sorter: "string", editor: "textarea", editable: true, headerFilter: "input", width: "200", formatter: "textarea", headerMenu: headerMenu });
        }
    }


    function getDropdown(cell) {
        return (allInitials);
    }
    //Create the Tabulator table:
    var table = new Tabulator("#contentTable", {
        groupToggleElement: "header",
        height: window.innerHeight / 3 * 2,
        layout: "fitColumns",
        // pagination:"local",
        // paginationSize:"20",
        movableRows: false,
        groupBy: "Id",
        groupStartOpen: true,
        persistence: true,
        keybindings: true,
        history: true, //records table interaction
        data: tableData,
        columns: columnData,
        reactiveData: true, //enables updating cell contents programmatically
        virtualDomBuffer: 1500, //may be needed to fix bug where up scroll is disappearing rows
        scrollToRowPosition: "bottom", //for scrollToRow()
        scrollToRowIfVisible: false, //don't scroll if row already on screen


        dataSorting: function (sorters) {
            //console.log("sorted");
            //sorters - an array of the sorters currently applied
        },
        //called when table rendered or re-drawn:
        tableBuilt: function () {

        },
        renderStarted: function () {

        },
        renderComplete: function () {
            try {
                table.scrollToRow(rowValue); // todo: rowValue needs to be updated in several places - is this the best approach?
                var row = table.getRowFromPosition(0, true);
                var cell = row.getCell("parent");
                cell.setValue("replaced");
            } catch {
                //console.log("caught"); //this happens on initial load, table loaded twice?
            }
        },

        columnResized: function (column) {
            //console.log("resized"); //not triggering on hide, show column dropdown
        },

        //todo: select all checkbox doesn't trigger rowSelected (no highlight, still deletes though...) - maybe it's just slow?
        rowSelected: function (row) {
            var data = row.getData();
            //show buttons concerning rows:
            $('#delete-rows').show();
            if (data[curation_status] === undefined) { //for tables without curation_status
                //don't show some buttons if in a table where they are not needed
            } else {
                //show buttons to do with rows and curation status
                $('#ask-for-review').show();
                $('#reviewed').show();
            }
            row.getElement().style.backgroundColor = 'grey';
            rowValue = row.getPosition(true);
        },

        rowDeselected: function (row) {
            var data = row.getData();
            var selectedRows = table.getSelectedRows();
            if (selectedRows.length > 0) {
                //some rows still selected, do nothing
            } else {
                //no rows still selected, hide buttons to do with rows
                $('#delete-rows').hide();
                $('#ask-for-review').hide();
                $('#reviewed').hide();
            }

            row.getElement().style.backgroundColor = 'white';
            //re-do styling
            if (data[curation_status] !== null) {
                rowColours(row, data);
            }
            rowValue = row.getPosition(true);
        },


        cellClick: function (e, cell) {
            //WARNING: THIS DOES NOT TRIGGER ON FIREFOX!
            var row = cell.getRow();
            var data = row.getData();
        },

        cellEditing: function (cell) {
            var row = cell.getRow();
            rowValue = row.getPosition(true);
            var data = row.getData();
            var column = cell.getColumn();
            rowValue = row.getPosition(true);
            // console.log(cell.getValue()); //this works
            // console.log("cellEditing column is: " + column.getDefinition().title)
            //save backup curation status if "Curation status" column present: 
            if (data[curation_status] === undefined) { //Curation status column not present in table

            } else {
                if (column.getDefinition().title.toLowerCase().replace(/\s+/g, '').indexOf(curation_status.toLowerCase()) == -1) {
                    prevCurationStatus = cell.getValue();
                    console.log("PREV CURATION STATUS IS: " + prevCurationStatus)
                }
            }
        },


        cellEdited: function (cell) {
            cell.getElement().style.color = "#003399"; //change text colour on edited
            var row = cell.getRow();
            var data = row.getData();
            var column = cell.getColumn();
            console.log("cellEdited: " + cell.getValue() + ", " + row.getPosition() + ", " + column.getDefinition().title);
            // console.log("cellEdited column is: " + column.getDefinition().title);

            //save changed cell data:
            //{value, row, columnName}
            if (cell.getValue() !== "" && cell.getValue() !== null) {
                rowValue = row.getPosition();//save absolute row position
                columnValue = cell.getField(); //column name
                var alreadyChanged = false;
                //check for previously edited cell, and overwrite if already changed before
                for (var i = 0; i < changes.length; i++) {
                    if (rowValue == changes[i]) { //matches row number
                        if (columnValue == changes[i + 1]) { //matches column name as well
                            console.log("already edited this field");
                            changes.splice(i - 1, 3, cell.getValue(), rowValue, columnValue);
                            alreadyChanged = true;
                        }
                    }
                }
                if (!alreadyChanged) {
                    changes.push(cell.getValue());
                    changes.push(rowValue);
                    changes.push(columnValue);
                }
            }

            //update highlighting:
            if (data[curation_status] === undefined) {

            } else {
                //re-do styling
                if (data[curation_status] !== null) {
                    rowColours(row, data);
                }

                //override for "External" Curation status:
                //If "ID" changed to "ADDICTO" or "BCIO" (in corresponding repo), "Curation status" must be set to "Proposed"
                if (cell.getValue() !== "" && cell.getValue() !== null) {
                    rowValue = row.getPosition();//save absolute row position
                    columnValue = cell.getField(); //column name
                    if (cell.getValue().includes(repo_name.toUpperCase())) {
                        if (data[curation_status] == "External") { //
                            data[curation_status] = "Proposed"; //change "External" to "Proposed", but don't change any other status to "Proposed" (for eg if just editing)
                        }
                    }
                }
                if (data["ID"] == undefined) {
                    //no "ID" column
                } else {
                    if (data["ID"] == "" || data["ID"] == null) {
                        //not External
                    } else {
                        //different repo's: 
                        if (repo_name == "BCIO") {
                            if (data["ID"].includes("BCIO")) {
                                //not external
                            } else {
                                data[curation_status] = "External";
                            }
                        } else { //"AddictO repo"
                            if (data["ID"].includes("ADDICTO")) {
                                //not external
                            } else {
                                data[curation_status] = "External";
                            }
                        }
                    }
                }


                // }

                // if (data["ID"] === undefined) {

                // } else {
                //     if (data["ID"].includes("ADDICTO") || data["ID"].includes("BCIO")) {
                //         if (data[curation_status] == "External") {
                //             data[curation_status] = "Proposed";
                //         }
                //     } else {
                //         if (data["ID"] == "" || data["ID"] == null) {
                //             //no change
                //         } else {
                //             data[curation_status] = "External";
                //         }

                //         //colour changed in "rowColours" function
                //     }

                // }

            }



            //if a field in any column except "Curator" edited
            //check "Curator" column for loginInitials and auto fill
            if (cell.getValue() !== "" && cell.getValue() !== null) {
                if (data[curator] === undefined) { //curator column not present in table

                } else {
                    if (column.getDefinition().title.toLowerCase().replace(/\s+/g, '').indexOf(curator.toLowerCase()) == -1) {
                        if (cell.getValue() !== "") { //stop saving curator when cell is empty - still saves if there are spaces... not an issue?
                            if (data[curator] !== null && data[curator] !== "") {
                                var prevCurator = data[curator];
                                var nameCheck = prevCurator.indexOf(loginInitials);
                                if (nameCheck > -1) {
                                    //name exists, don't update
                                } else {
                                    data[curator] = prevCurator + "; " + loginInitials;
                                }
                            } else {
                                data[curator] = loginInitials;
                            }
                        } else {
                            data[curator] = loginInitials;
                        }
                        //save curator column to local storage for backup here
                        //{value, row, columnName}
                        //data[curator], row.getPosition(), "Curator"
                        if (data[curator] !== "" && data[curator] !== null) {
                            rowValue = row.getPosition();//save absolute row position
                            columnValue = "Curator"; //column name
                            var alreadyChanged = false;
                            //check for previously edited cell, and overwrite if already changed before
                            for (var i = 0; i < changes.length; i++) {
                                if (rowValue == changes[i]) { //matches row number
                                    if (columnValue == changes[i + 1]) { //matches column name as well
                                        console.log("already edited this field");
                                        changes.splice(i - 1, 3, data[curator], rowValue, columnValue);
                                        alreadyChanged = true;
                                    }
                                }
                            }
                            if (!alreadyChanged) {
                                changes.push(data[curator]);
                                changes.push(rowValue);
                                changes.push(columnValue);
                            }
                        }

                        //text must be coloured if highlighting login set though..
                        if (highlightLogin) {
                            if (data[curator] !== null) {
                                var curatorA = data[curator];
                                if (curatorA !== null) {
                                    var nameCheckA = curatorA.indexOf(loginInitials);
                                    if (nameCheckA > -1) {
                                        row.getElement().style.color = 'black';
                                        row.getElement().style.fontWeight = 'bold';
                                    }
                                }
                            }
                        }
                    } else { //if editing "Curator" column, text must be coloured if highlighting login set
                        if (highlightLogin) {
                            if (data[curator] !== null && data[curator] !== "") {
                                var curatorB = data[curator];
                                if (curatorB !== null) {
                                    var nameCheckB = curatorB.indexOf(loginInitials);
                                    if (nameCheckB > -1) {
                                        row.getElement().style.color = 'black';
                                        row.getElement().style.fontWeight = 'bold';
                                    }
                                }
                            } else {
                                row.getElement().style.color = 'black'; //change back to
                            }
                        }
                    }
                }
            }

            //If the user enters anything in the ‘Why fuzzy’ column automatically set the ‘Fuzzy set’ column to true
            //todo: do we need to remove checkbox if user deletes their 'Why fuzzy' comment?
            if (data[why_Fuzzy] === undefined) { //why Fuzzy column not present

            } else {
                if (column.getDefinition().title.toLowerCase().replace(/\s+/g, '').indexOf(whyFuzzy.toLowerCase()) !== -1) {
                    if (cell.getValue() !== "") {
                        if (data[why_Fuzzy] !== null && data[why_Fuzzy] !== "") {
                            data[fuzzy_Set] = 1;
                            //save Fuzzy set column to local storage for backup here
                            //{value, row, columnName}
                            //data[curator], row.getPosition(), "Curator"
                            // if(data["Fuzzy set"] !== "" && data["Fuzzy set"] !== null){
                            rowValue = row.getPosition();//save absolute row position
                            columnValue = fuzzy_Set; //column name
                            var alreadyChanged = false;
                            //check for previously edited cell, and overwrite if already changed before
                            for (var i = 0; i < changes.length; i++) {
                                if (rowValue == changes[i]) { //matches row number
                                    if (fuzzy_Set == changes[i + 1]) { //matches column name as well
                                        console.log("already edited this field");
                                        changes.splice(i - 1, 3, 1, rowValue, fuzzy_Set);
                                        alreadyChanged = true;
                                    }
                                }
                            }
                            if (!alreadyChanged) {
                                changes.push(1);
                                changes.push(rowValue);
                                changes.push(fuzzy_Set);
                            }
                            // }
                        }
                    }
                }
            }

            // workflow (for "Curation status"): 
            // 1. Can't change status to 'published' unless status is 'discussed' and that status has been saved
            //      - if user tries to change status to 'published' but it was not in 'discussed', their change
            //      should be reverted to whatever status it was before, and user should be shown a message saying that 
            //      you can't change to 'published' without setting to 'discussed' first and saving that
            // 2. Once in 'published', can't change status to anything but 'obsolete'. 
            //      - if user tries to change status out of 'published' to anything else, their change should be 
            //      reverted and a popup message says "are you sure" as if they are trying to delete it
            // 3a. It shouldn't be possible to set curation status to Discussed if there are empty values 
            //     in any of the Label, Definition, and Parent columns. 
            //     These should all be populated before a row can go into Discussed. 
            // 3b. And then an additional requirement for the Published status is that 
            //     it's not possible to go to Published status without a value in the ID column. 



            if (data[curation_status] === undefined) { //Curation status column not present in table

            } else {
                if (column.getDefinition().title.toLowerCase().replace(/\s+/g, '').indexOf(curation_status.toLowerCase()) == -1) {
                    console.log(prevCurationStatus + " is now changed to " + cell.getValue()); //before and after values
                    console.log("column is: " + column.getDefinition().title);
                    // 1.
                    if (cell.getValue() == "Published") {
                        var savedCellDiscussed = false; //for saved version "Discussed" status
                        if (!tableEdited) {
                            savedCellDiscussed = true;
                        } else {
                            //need to check saved table to see if status for this row was "Discussed" or not: 
                            //get column number programatically: ///////////////////////////////////////////////
                            var currentColumnNumber = headerLength - 2; //fallback, for now
                            for (var i = 0; i < headerLength; i++) {
                                if (headers[i] == curation_status) {
                                    console.log("reached correct column" + i);
                                    currentColumnNumber = i;
                                }
                            }
                            var dValue = "Proposed";
                            // console.log("rowData.length : " + rowData.length + "and rowValue is: " + rowValue);
                            //check for new row:                             
                            if (rowValue >= rowData.length) {
                                console.log("rowData is undefined, must be new row?");
                            } else {
                                dValue = rowData[rowValue][headers[currentColumnNumber]];
                            }

                            //////////////////////////////////////////////////////////////////////////////
                            if (dValue === "Discussed") {
                                savedCellDiscussed = true;
                            }
                        }
                        if (prevCurationStatus == "Discussed" && savedCellDiscussed) {
                            //additional check for empty "ID" column here: 
                            if (data["ID"] == null || data["ID"] == "") {
                                bootbox.alert("'ID' needs to be set first");
                                data[curation_status] = prevCurationStatus; //reverting here
                                //revert to prevCurationStatus and send a message
                            }
                            console.log("this is fine");
                            //this is fine, allow it
                        } else {
                            bootbox.alert("You can't change to 'Published' without setting to 'Discussed' first and saving your change");
                            data[curation_status] = prevCurationStatus; //reverting here
                            //revert to prevCurationStatus and send a message
                        }
                    }
                    // 2. 
                    if (prevCurationStatus == "Published") {
                        if (cell.getValue() !== "Obsolete") {
                            bootbox.alert("Not possible to change 'Published' to anything other than 'Obsolete'");
                            data[curation_status] = prevCurationStatus; //reverting here
                            //revert to prevCurationStatus and send a message "are you sure?"
                        } else {
                            console.log("this is fine");
                            //this is fine, allow it
                        }
                    }
                    //3. 
                    //if setting to "Discussed"
                    if (cell.getValue() == "Discussed" && prevCurationStatus !== "Discussed") { //prevCurationStatus !== "Discussed" to make sure we aren't just re-setting it somewhere else
                        if (data["Label"] == null || data["Label"] == "" | data["Definition"] == null || data["Definition"] == "" | data["Parent"] == null || data["Parent"] == "") {
                            bootbox.alert("'Label', 'Definition' and 'Parent' columns all need to be set first");
                            data[curation_status] = prevCurationStatus; //reverting here
                        } else {
                            console.log("All set. Label, Definition and Parent. Should be Discussed now");
                            //this is fine, allow it
                        }
                    }
                }
            }
            backupChanges(); //todo: as soon as user starts editing, conflicted save will be overwritten *what did I mean here? 
        },

        cellEditCancelled: function (cell) {

        },

        dataChanged: function (data) {
            tableEdited = true;
            $('#save-btn').show();
        },

        //highlight on load table:
        rowFormatter: function (row) {
            var data = row.getData();

            //hide unimportant buttons until rows selected:
            $('#delete-rows').hide();
            $('#ask-for-review').hide();
            $('#reviewed').hide();
            //update highlighting
            if (data[curation_status] === undefined) { //for tables without curation_status

            } else {
                if (data[curation_status] !== null) {
                    rowColours(row, data);
                }
            }

            if (highlightLogin) {
                if (data[curator] === undefined) {

                } else {
                    if (data[curator] !== null) {
                        var curatorA = data[curator];
                        var nameCheckA = curatorA.indexOf(loginInitials);
                        if (nameCheckA > -1) {
                            row.getElement().style.color = 'black';
                            row.getElement().style.fontWeight = 'bold';
                        }
                    }
                }
            } else {
                row.getElement().style.color = 'black';
                row.getElement().style.fontWeight = 'normal';
            }
        },

        rowAdded: function (row) {
            var rowZero = table.getRow(0); //will fail on empty spreadsheet, but "row" not working for new row..
            var data = rowZero.getData();

            table.scrollToRow(row, "bottom", false)
                .then(function () {
                    if (data["Label"] === undefined) { //"Label" column not present
                        // console.log("undefined label");
                    } else {
                        var cell = row.getCell("Label");
                        cell.getElement().focus(); //no focus for spreadsheets without "Label" column
                        // console.log("should focus here");
                    }
                })
                .catch(function (error) {
                    console.log("error scrolling");
                    //handle error scrolling to row
                });
            rowValue = row.getPosition(true);
            backupChanges(); //not for empty row maybe?
            // console.log(row.getData());
            var pos = row.getPosition();
            // console.log(pos);
        },

        // rowUpdated:function(row){

        // },
    });

    function rowColours(row, data) {

        if (data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(discussed.toLowerCase()) !== -1) {
            row.getElement().style.backgroundColor = 'moccasin'; //apply css change to row element
        }
        //change all "Ready" to "Published":
        if (data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(ready.toLowerCase()) !== -1) {
            data[curation_status] = "Published";
        }
        if (data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(proposed.toLowerCase()) !== -1) {
            row.getElement().style.backgroundColor = 'white'; //apply css change to row element
        }
        if (data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(toBeDiscussed.toLowerCase()) !== -1) {
            row.getElement().style.backgroundColor = 'palegoldenrod'; //apply css change to row element
        }
        if (data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(inDiscussion.toLowerCase()) !== -1) {
            row.getElement().style.backgroundColor = 'lemonchiffon'; //apply css change to row element
        }
        if (data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(published.toLowerCase()) !== -1) {
            row.getElement().style.backgroundColor = 'aquamarine'; //apply css change to row element
        }
        if (data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(obsolete.toLowerCase()) !== -1) {
            row.getElement().style.backgroundColor = 'darkslategrey'; //apply css change to row element
        }
        if (data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(external.toLowerCase()) !== -1) {
            row.getElement().style.backgroundColor = 'lightgrey'; //apply css change to row element
        }

    }
    //below recommended for Firefox in particular by Tabulator issue responseText
    //reference: https://github.com/olifolkerd/tabulator/issues/2117
    table.redraw(true); //may be needed to fix bug where up scroll is disappearing rows.
    backupChanges(); //todo:is this necessary here?

    //new row button click handler:
    $("#add-row").click(function () {
        // var rowObj = {};
        var sheetNamesArray = ["AddictO_Environmental_system_Defs.xlsx", "AddictO_Human-being_Defs.xlsx",
            "AddictO_Human_behaviour_Defs.xlsx", "AddictO_Human_population_Defs.xlsx", "AddictO_Intervention_Defs.xlsx",
            "AddictO_Not_yet_classified_Defs.xlsx", "AddictO_Organisation_Defs.xlsx", "AddictO_Product_Defs.xlsx",
            "AddictO_Research_activity_Defs.xlsx"];
        var AOsub_ontologyNames = ["Environmental system", "Human being", "Human behaviour", "Human population",
            "Intervention", "", "Organisation", "Product", "Research activity"];
        var rowObj = { id: 0 } //todo: what does this actually do? 
        for (var j = 0; j < headerLength; j++) {
            rowObj[headers[j]] = "";
            if (headers[j] == curation_status) { //column
                rowObj[headers[j]] = "Proposed";
            }
            //set null values to 0 in checkbox columns here:
            if (headers[j] == fuzzy_Set || headers[j] == "E-CigO") { //column
                if (rowObj[headers[j]] == null) {
                    rowObj[headers[j]] = 0;
                }
            }
            //set per-sheet “AO sub-ontology” column: "Product, Intervention, etc"
            if (headers[j] == AOsub_ontology) { //column
                for (var a = 0; a < sheetNamesArray.length; a++) {
                    if (sheetNamesArray[a] == thisSheet) {
                        rowObj[headers[j]] = AOsub_ontologyNames[a];
                    }
                }
            }
        }
        clearFormatting(); //needs to be here, not after table.addRow or bad things happen        
        table.addRow(rowObj);

        // backupChanges(); //done in rowAdded!
        //rowAdded triggered here
    });

    //delete row button click handler:
    $("#delete-rows").click(function () {
        var selectedRows = table.getSelectedRows();
        if (selectedRows.length > 1) {
            if (!confirm("Do you really want to delete these rows?")) { return; }
        } else if (selectedRows.length == 1) {
            if (!confirm("Do you really want to delete this row?")) { return; }
        } else {
            bootbox.alert("No rows selected");
            return;
        }
        //if selectedRows ID column is not null and "" then don't delete!
        selectedRows.forEach(function (row) {
            var data = row.getData();
            if (data["ID"] === undefined) {
                table.deleteRow(row);
                // if (row.getCell("ID") === undefined) {
                console.log("ID undefined");
            } else {
                var data = row.getData();
                var cell = row.getCell("ID");
                if (cell.getValue() !== "" && cell.getValue() !== null) {

                } else {
                    table.deleteRow(row);
                }
            }
        });
        // table.deleteRow(selectedRows);
        backupChanges(); //has no effect
    });

    // Hightlight your rows
    $("#highlight-user").click(function () {
        highlightLogin = !highlightLogin;
        if (highlightLogin) {
            this.children[0].style.color = "#333300"; //colour of marker
        } else {
            this.children[0].style.color = null;
        }
        //deselect any selected rows as this was causing a inconsistent update problem in renderComplete: 
        var selectedRows = table.getSelectedRows();
        //console.log(selectedRows);
        if (selectedRows == "") {

        } else {
            selectedRows.forEach(function (row) {
                row.deselect();
            });
        }
        table.redraw(true);
        //renderComplete triggered here 
    });

    $("#remove-formatting").click(function () {
        clearFormatting();
    });

    $("#ask-for-review").click(function () {
        //console.log("ask for review");
        var selectedRows = table.getSelectedRows();
        //console.log(selectedRows);
        if (selectedRows == "") {
            bootbox.alert("No rows selected");
        } else {
            var inputArray = [];
            for (var i = 0; i < allInitials.length; i++) {
                inputArray.push({ text: allInitials[i], value: allInitials[i] });
            }
            bootbox.prompt({
                title: "Choose reviewers",
                inputType: 'checkbox',
                inputOptions: $(inputArray),
                callback: function (result) {
                    if (result === null || result === "") { //cancel or no curator selected
                        // row.deselect(); //probably not a good idea.. maybe they made a mistake and want to do something else.
                    } else {
                        selectedRows.forEach(function (row) {
                            //logic:
                            //1. Don't repeat initials already present
                            //2. add selected initials (in dropdown) to cell
                            //3. join with "; " except the first one (if cellValue !== null)
                            var data = row.getData();
                            var cell = row.getCell(to_be_reviewed_by);
                            //save "curator":
                            saveCurator(row);
                            var cellValue = cell.getValue();
                            var reviewedCell = "";
                            var addData = result.join("; ");
                            if (cellValue !== null && cellValue !== "") {
                                reviewedCell = cellValue + "; " + addData;
                            } else {
                                reviewedCell = addData;
                            }
                            row.update({ "To be reviewed by": reviewedCell });
                            row.deselect();
                            //backup changes:
                            if (data[to_be_reviewed_by] !== "" && data[to_be_reviewed_by] !== null) {
                                rowValue = row.getPosition();//save absolute row position
                                columnValue = "To be reviewed by"; //column name
                                var alreadyChanged = false;
                                //check for previously edited cell, and overwrite if already changed before
                                for (var i = 0; i < changes.length; i++) {
                                    if (rowValue == changes[i]) { //matches row number
                                        if (columnValue == changes[i + 1]) { //matches column name as well
                                            console.log("already edited this field");
                                            changes.splice(i - 1, 3, data[to_be_reviewed_by], rowValue, columnValue);
                                            alreadyChanged = true;
                                        }
                                    }
                                }
                                if (!alreadyChanged) {
                                    changes.push(data[to_be_reviewed_by]);
                                    changes.push(rowValue);
                                    changes.push(columnValue);
                                }
                            }
                            backupChanges();
                        });
                    }
                }
            });
        }
    });

    $("#reviewed").click(function () {
        var selectedRows = table.getSelectedRows();
        //console.log(selectedRows);
        if (selectedRows == "") {
            bootbox.alert("No rows selected");
        }

        selectedRows.forEach(function (row) {
            if (row.getCell(to_be_reviewed_by) === undefined) {

            } else {
                var data = row.getData();
                var cell = row.getCell(to_be_reviewed_by);
                //save "curator":
                saveCurator(row);
                var cellValue = cell.getValue();
                var reviewedCell = "";
                //three options to replace (eg if loginInitials are "to"):
                // ; to | to; | to
                //added two new options, ;to|to; - without spaces
                // todo: how to check for arbitrary number of spaces? 
                var semiFirstNoSpace = ";" + loginInitials;
                var semiAfterNoSpace = loginInitials + ";";

                var semiFirst = "; " + loginInitials;
                var semiAfter = loginInitials + "; ";

                if (cellValue !== null) {
                    reviewedCell = cellValue.replace(semiFirst, '');
                    reviewedCell = reviewedCell.replace(semiAfter, '');
                    //replace if without spaces:
                    reviewedCell = cellValue.replace(semiFirstNoSpace, '');
                    reviewedCell = reviewedCell.replace(semiAfterNoSpace, '');

                    reviewedCell = reviewedCell.replace(loginInitials, '');
                }
                row.update({ "To be reviewed by": reviewedCell });
                row.deselect(); //triggers rowDeselected()
                //backup changes
                if (data[to_be_reviewed_by] !== "" && data[to_be_reviewed_by] !== null) {
                    rowValue = row.getPosition();//save absolute row position
                    columnValue = "To be reviewed by"; //column name
                    var alreadyChanged = false;
                    //check for previously edited cell, and overwrite if already changed before
                    for (var i = 0; i < changes.length; i++) {
                        if (rowValue == changes[i]) { //matches row number
                            if (columnValue == changes[i + 1]) { //matches column name as well
                                console.log("already edited this field");
                                changes.splice(i - 1, 3, data[to_be_reviewed_by], rowValue, columnValue);
                                alreadyChanged = true;
                            }
                        }
                    }
                    if (!alreadyChanged) {
                        changes.push(data[to_be_reviewed_by]);
                        changes.push(rowValue);
                        changes.push(columnValue);
                    }
                }
                backupChanges();
            }
        });

    });

    $('#contentTable').ready(function () {
        //warn user if unsaved changes:
        window.onbeforeunload = function (e) {
            if (tableEdited) {
                if (e) {
                    var message = "You have not saved your changes.";
                    e.returnValue = message;
                }
                return message;
            }
        };

    });


    function saveCurator(row) {
        //if a field in any column except "Curator" edited
        //check "Curator" column for loginInitials and auto fill
        var data = row.getData();
        if (data[curator] === undefined) { //curator column not present in table

        } else {

            if (data[curator] !== null && data[curator] !== "") {
                var prevCurator = data[curator];
                var nameCheck = prevCurator.indexOf(loginInitials);
                if (nameCheck > -1) {
                    //name exists, don't update
                } else {
                    data[curator] = prevCurator + "; " + loginInitials;
                }
            } else {
                data[curator] = loginInitials;
            }

            //save curator column to local storage for backup here
            //{value, row, columnName}
            //data[curator], row.getPosition(), "Curator"
            if (data[curator] !== "" && data[curator] !== null) {
                rowValue = row.getPosition();//save absolute row position
                columnValue = "Curator"; //column name
                var alreadyChanged = false;
                //check for previously edited cell, and overwrite if already changed before
                for (var i = 0; i < changes.length; i++) {
                    if (rowValue == changes[i]) { //matches row number
                        if (columnValue == changes[i + 1]) { //matches column name as well
                            console.log("already edited this field");
                            changes.splice(i - 1, 3, data[curator], rowValue, columnValue);
                            alreadyChanged = true;
                        }
                    }
                }
                if (!alreadyChanged) {
                    changes.push(data[curator]);
                    changes.push(rowValue);
                    changes.push(columnValue);
                }
            }
        }

    }

    function backupChanges() {
        var tableArray = table.getData();
        //whole table:
        var jsonArray = JSON.stringify(tableArray);
        localStorage.setItem("savedTableData" + thisSheet, jsonArray);
        //changed cells:
        if (changes.length > 0) {
            var cellArray = JSON.stringify(changes);
            localStorage.setItem("savedChanges" + thisSheet, cellArray);
            console.log("changes.length = " + changes.length);
        }
        console.log("changes backed up");
    }

    function clearFormatting() {
        table.clearSort(); //clear sorting as well
        table.clearFilter(true); //clear header filters       
    }

    /**
    * Submit a pull request to github to update the given configuration file in the repository.
    */
    // todo: add testTableData to the list of arguments below - send to server and use daff to compare. 
    // also add boolean (overwrite) for overwriting server version (after review only!)
    var save_changes = function (repo_key, folder, spreadsheet, rowData, initialData, overwrite) {
        $("#commit-msg").attr('value', 'Updating ' + spreadsheet);

        // Get a confirmation from the user:
        var modal = bootbox.dialog({
            title: "You are about to submit changes. Please describe the changes you have made to " + spreadsheet,
            message: $("#message-box").html(),
            buttons: {
                confirm: {
                    label: 'Submit',
                    className: 'btn-danger',
                    callback: function () {
                        var aForm = modal.find(".form");
                        var formData = aForm.serializeArray(),
                            dataObj = {};
                        $(formData).each(function (i, field) {
                            dataObj[field.name] = field.value;
                        });
                        var commit_msg = dataObj["commit-msg"];
                        var msgBody = dataObj["descr"];
                        if (commit_msg !== null && commit_msg !== undefined) {
                            if (!commit_msg || commit_msg.trim() === "") {
                                bootbox.alert({
                                    closeButton: false,
                                    message: "Commit message cannot be empty. Your change has not been submitted."
                                });
                                return;
                            }

                            // Embed the code into a request.
                            var request = new XMLHttpRequest();
                            // Define a function to handle a state change of the request:
                            request.onreadystatechange = function () {
                                $("*").css("cursor", "default");
                                if (request.readyState === 4) {
                                    if (!request.status) {
                                        bootbox.alert("Problem communicating with server");
                                    }
                                    else if (request.status === 200) {
                                        window.localStorage.removeItem("savedChanges" + thisSheet);  //remove saved changes from localStorage
                                        changes = []; //no changes anymore to save
                                        backupChanges();
                                        var response = JSON.parse(request.responseText);
                                        var new_file_sha = response['file_sha'];
                                        file_sha = new_file_sha;
                                        $('#saveAlert').removeClass('alert-danger');
                                        $('#saveAlert').addClass('alert-success');
                                        $("#saveMessage").text('Changes were saved successfully to the repository. ');
                                        $("#saveAlert").dismissed = false;
                                        $("#saveAlert").show();
                                        $('#save-btn').hide(); //saved successfully, hide save button

                                        var rows = table.getRows();
                                        for (i = 0; i < rows.length; i++) {
                                            var cells = rows[i].getCells();
                                            for (j = 0; j < cells.length; j++) {
                                                cells[j].getElement().style.color = 'black'; //do we want to change all to black?
                                            }
                                        }
                                        if (tableEdited) {
                                            tableEdited = false;
                                        }

                                    } else {
                                        var response = JSON.parse(request.responseText);
                                        var errInfo = response['Error'];
                                        var mergeInfo = response['merge_diff'];

                                        //new updated sheet here: /////////////////////////////////////////////
                                        var rows3 = response['rows3'];
                                        var header3 = response['header3'];
                                        var row3Length = rows3.length;
                                        var header3Length = header3.length;
                                        console.log("row3Length is: " + row3Length);
                                        var testTableData3 = [];

                                        //get saved table data, compare to current table:
                                        // for (var i = 0; i < row3Length; i++) {
                                        //     var rowObj3 = { id: i }
                                        //     for (var j = 0; j < header3Length; j++) {
                                        //         rowObj3[header3[j]] = rows3[i][header3[j]];
                                        //     }
                                        //     testTableData3.push(rowObj3);
                                        // }
                                        //saved table data 3, the right way: 
                                        for (var i = 0; i < row3Length; i++) {
                                            var rowObj3 = { id: i }
                                            for (var j = 0; j < header3Length; j++) {
                                                rowObj3[header3[j]] = rows3[i][header3[j]];
                                                //trying to set null values to 0 in checkbox columns here:
                                                if (header3[j] == fuzzy_Set || header3[j] == "E-CigO") { //column
                                                    if (rowObj3[header3[j]] == null) {
                                                        rowObj3[header3[j]] = 0;
                                                    }
                                                    /////////////////////fix E-CigO removing ticks///////////////////////
                                                    if (rowObj3[header3[j]] == 1) {
                                                        rowObj3[header3[j]] = 1;
                                                    }
                                                    ////////////////////////////////////////////////////////////////////
                                                } else {
                                                    if (rowObj3[header3[j]] == null) {
                                                        rowObj3[header3[j]] = ""; //change all null to ""
                                                    }
                                                }
                                                //All rows with empty IDs --> not external. 
                                                //Rows with AddictO IDs in AddictO repo or BCIO IDs in BCIO repo --> not external. 
                                                //Only rows with  non-empty IDs, that are not matching the project ID template, are external.
                                                //adding "External" status 
                                                if (header3[j] == curation_status) { //column
                                                    // console.log("repo_name is: " + repo_name);
                                                    if (rowObj3["ID"] == undefined) {
                                                        //no "ID" column
                                                    } else {
                                                        if (rowObj3["ID"] == "" || rowObj3["ID"] == null) {
                                                            //not External
                                                        } else {
                                                            //different repo's: 
                                                            if (repo_name == "BCIO") {
                                                                //todo: is there no change for "" and null here as well? 
                                                                if (rowObj3["ID"].includes("BCIO")) {
                                                                    //not external
                                                                } else {
                                                                    rowObj3[header3[j]] = "External";
                                                                }
                                                            } else { //"AddictO repo"
                                                                if (rowObj3["ID"].includes("ADDICTO")) {
                                                                    //not external
                                                                } else {
                                                                    rowObj3[header3[j]] = "External";
                                                                }
                                                            }
                                                        }
                                                    }


                                                }
                                            }
                                            testTableData3.push(rowObj3);
                                        }
                                        if (JSON.stringify(testTableData3) === JSON.stringify(tableData)) { 
                                            console.log("OLD === NEW");
                                        } else {
                                            console.log("OLD != NEW");
                                            // console.log(JSON.stringify(testTableData3));
                                            // console.log(JSON.stringify(tableData));
                            
                                            var conflicted = false;

                                            //todo: compare number of rows (or use daff diff?) for differences, as new rows are not dealt with in my merger below!

                                            //check changes[] array against corresponding values
                                            var mergeTable = testTableData3;
                                            for (var i = 0; i < row3Length; i++) {
                                                console.log("ID is: " + testTableData[i]["ID"]);

                                                // var rowObj3 = { id: i }
                                                for (var j = 0; j < header3Length; j++) { //an additional "id" column is present?!
                                                    
                                                    for (var a = 0; a < changes.length; a++) {
                                                        if (i == changes[a + 1]) { //row
                                                            if (header3[j] == changes[a + 2]) { //column
                                                                if (testTableData3[i][changes[a + 2]] === changes[a]) { //new same as saving
                                                                    console.log("old is same as new"); //todo: merge is safe so merge here
                                                                } else {
                                                                    //check initial data for null and "":
                                                                    var compareData = "";
                                                                    if (testTableData[i][changes[a + 2]] == undefined || testTableData[i][changes[a + 2]] == null) {
                                                                        compareData = "";
                                                                    } else{
                                                                        compareData = testTableData[i][changes[a + 2]];
                                                                    }
                                                                    //compare:
                                                                    if(testTableData3[i][changes[a + 2]] === compareData){ //new same as initial
                                                                        console.log("initial same as new");
                                                                        //add to testTableData3 array?
                                                                        mergeTable[i][changes[a + 2]] === compareData;
                                                                    } else{
                                                                        console.log("conflict: " + testTableData3[i][changes[a + 2]] + " vs " + changes[a] + " on " + changes[a+2]);
                                                                        conflicted = true;
                                                                    }                                                                    
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            console.log("conflicted? " + conflicted);                                       
                    
                                        }
                                        //////// end deal with updated sheet from server ///////////////////////////

                                        $('#saveAlert').removeClass('alert-success');
                                        $('#saveAlert').addClass('alert-danger');
                                        $("#saveMessage").append('"It looks as though you might have unsaved changes, although this could also happen if you navigated away from the screen while the save was happening: ' + errInfo);
                                        $("#saveMessage").append('Merge info (remote changes first): ' + mergeInfo); //todo: do we need to show this? 
                                        // $("#saveMessage").append('There was a problem saving changes: ' + errInfo + "--->" + mergeInfo);                                       
                                        $(".alert").alert()
                                        $("#saveAlert").show(); 
                                        //new modal dialog here. Options: "Keep Both", "Overwrite", "Cancel changes"
                                        //todo: only show this if save changes has been pressed again
                                        //todo: maybe have a new button (same place) with the prompt below? 
                                        $('#save-btn').removeClass('alert-success');
                                        $('#save-btn').addClass('alert-danger');
                                         bootbox.prompt({
                                            title: "What would you like to do with the changes?",
                                            inputType: 'select',
                                            inputOptions: [
                                                {
                                                    text: 'Options:',
                                                    value: ''
                                                },
                                                {
                                                    text: 'Keep both',
                                                    value: '1'
                                                },
                                                {
                                                    text: 'Overwrite remote changes',
                                                    value: '2',
                                                },
                                                {
                                                    text: 'Lose your changes',
                                                    value: '3'
                                                }],
                                            callback: function (result) {
                                                console.log(result);
                                                switch (result) {
                                                    case '1':
                                                        if(!conflicted){
                                                            alert(result + " Able to merge");
                                                            //todo: combine the tables and merge here with final check
                                                            save_changes('{{repo_name}}', '{{folder}}', '{{ spreadsheet_name }}', JSON.stringify(mergeTable), JSON.stringify( testTableData ), 'true'); //overwrite is true now

                                                            //todo: what about deleted rows? ??? NO the row data is kept
                                                            //ok if we delete and add a row it will change the row number so not absolute here...
                                                        } else{
                                                            alert(result + " Need to resolve a Data Conflict here");
                                                        }
                                                        
                                                        break;
                                                    case '2':
                                                        save_changes('{{repo_name}}', '{{folder}}', '{{ spreadsheet_name }}', JSON.stringify(table.getData()), JSON.stringify( testTableData ), 'true');
                                                        break;
                                                    case '3':
                                                        //delete saved changes?
                                                        unsavedChanges = false;
                                                        //remove previous table array
                                                        // window.localStorage.removeItem("savedTableData" + thisSheet); //is this necessary? 
                                                        //refresh sheet
                                                        location.reload(true);
                                                        // alert(result + "does nothing yet");
                                                        break;
                                                    default:
                                                        // alert(result + "does nothing yet");
                                                }

                                                // $("#saveMessage").text(''); //reset message
                                                // $("#saveAlert").hide();
                                                $("tr").each(function(){
                                                    if($(this).hasClass("remove")){
                                                        console.log("REMOVE DETECTED");
                                                    }
                                                    if($(this).hasClass("add")){
                                                        console.log("ADD DETECTED");
                                                    }
                                                });
                                                $("td").each(function(){
                                                    if($(this).hasClass("modify")){
                                                        console.log("MODIFY DETECTED");
                                                    }
                                                    if($(this).hasClass("conflict")){
                                                        console.log("CONFLICT DETECTED");
                                                    }
                                                });
                                                $("tr.remove").css('background-color', '#DAA520');
                                                $("tr.add").css('background-color', '#7CFC00');
                                                $("td.modify").css('background-color', '#00FF00');
                                                $("td.conflict").css('background-color', '#FF69B4'); //add "CONFLICT!" MESSAGE?
                                            }
                                        });
                                    }
                                }
                            }
                            // Post the request to the server.
                            //todo: need to send the original loaded data here as well. 
                            request.open('POST', '/save', true);
                            request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                            request.send('repo_key=' + repo_key +
                                '&folder=' + folder +
                                '&spreadsheet=' + spreadsheet +
                                '&rowData=' + rowData +
                                '&initialData=' + initialData +
                                '&commit_msg=' + commit_msg +
                                '&commit_msg_extra=' + msgBody +
                                '&file_sha= ' + file_sha +
                                '&overwrite=' + overwrite);
                            $("*").css("cursor", "progress");
                        }
                    }
                },
                cancel: {
                    label: 'Cancel',
                    className: 'btn-primary'
                }
            }
        });
    };




    /** Hide save results message */
    $("#closeSaveMsgBtn").click(function () {
        $("#saveMessage").text('');
        $(this).parent().hide();
    });

    //override ctrl-s save:
    jQuery(document).keydown(function (event) {
        // If Control or Command key is pressed and the S key is pressed
        // run save function. 83 is the key code for S.
        if ((event.ctrlKey || event.metaKey) && event.which == 83) {
            // Save Function
            event.preventDefault();
            console.log("Save!");
            if (tableEdited) {
                $('#save-btn').trigger('click');
            }
            return false;
        }
    });
</script>

{% endblock %}