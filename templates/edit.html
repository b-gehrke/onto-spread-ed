{% extends "base.html" %}
{% block title %}{{ config['APP_TITLE'] }}{% endblock %}
{% block head %}
  {{ super() }}

{% endblock %}
{% block content %}
<!-- //fontawesome: -->
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.1/css/all.css" crossorigin="anonymous">

    <h2> Editing {{spreadsheet_name}} </h2>

<div class="row">
    <div class="col-md-4">
        <button id=add-row><i class="fas fa-plus"></i> Add Row</button>
    </div>
    <div class="col-md-4">
        <button id=delete-row><i class="fas fa-trash-alt"></i> Delete Row</button>
    </div>
    <div class="col-md-4">
         <!-- //todo: highlight-user button same colour as row highlight colour? -->
        <button id=highlight-user><i class="fas fa-highlighter"></i> Highlight Your Rows</button>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
    <div id="contentTable" class="table table-bordered table-hover table-sm">
    </div>
    </div>
</div>

{% endblock %}

{% block javascriptblock %}
<!-- //tabulator: -->

<link href="https://unpkg.com/tabulator-tables@4.8.2/dist/css/tabulator_simple.min.css" rel="stylesheet">
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.8.2/dist/js/tabulator.min.js"></script>


<script type="text/javascript">
    // Column name for curation status
    var curation_status = "Curation status"

    // For the curation status, the allowed values
    var discussed = "Discussed";
    var ready = "Ready";
    var proposed = "Proposed";

    //Column name for Proposer
    var proposer = "Proposer";

    //Get the row data from the Jinja template object "rows"
    var rowData = {{ rows | safe }};
    var rowLength = rowData.length;

    var headers = {{ header | safe }};
    var headerLength = headers.length;

    //Build the table row data with field names
    var tableData = [];
    for (var i=0; i<rowLength; i++) {
        var rowObj = {id:i}
        for (var j=0; j<headerLength; j++) {
            rowObj[ headers[j] ] = rowData[i][ headers[j] ];
        }
        tableData.push(rowObj);

        
    }

    

    //todo: do we need to build fields array - I read that fields need to be lowercase without spaces for parts of Tabulator to work
    //var fields = [];
    //for (var k=0; k<headerLength; k++) {
    //    fields.push(headers[k].toLowerCase().replace(/\s+/g, ''));
    //}

    //login
    
    var loginName = "{{login}}"; 
    var highlightLogin = false; //highlight user edited tables
    
    
    //header menu:
    //define row context menu
    //todo: resize to header text or initial value per header?
var headerMenu = [
    {
        label:"Hide Column",
        action:function(e, column){
            column.setWidth(30);
        }
    },
    {
        label:"Show Column",
        action:function(e, column){
            column.setWidth(200);
        }
    },
]

    //Build the column data from the Jinja template object "header"
    var columnData = []; //Start with an empty array
    //checkbox row selector on the side:
    columnData.push({formatter:"rowSelection", titleFormatter:"rowSelection", width:"50", hozAlign:"center", headerSort:false});
    for (var i=0; i<headerLength; i++) {
        //Dropdown list for "Curation status":
        //Todo: do I need to sanitize this? Need to support "Curation Status", "CurationStatus"?
        if(headers[i] == "Curation status"){
            columnData.push({title:headers[i], field:headers[i], editor: "select", editable:true, editorParams:{values:["Proposed", "Discussed", "Ready"]}, headerFilter:"input", width:"200", formatter:"textarea", headerMenu:headerMenu});
        } else if(headers[i] == "E-CigO"){ //todo: headerFilter can't select by unchecked?
            columnData.push({title:headers[i], field:headers[i], hozAlign:"center", editor:true, formatter:"tickCross", headerFilter:true, width:"50", headerMenu:headerMenu});
        }else if(headers[i] == "Fuzzy set"){ 
            columnData.push({title:headers[i], field:headers[i], hozAlign:"center", editor:true, formatter:"tickCross", headerFilter:true, width:"50", headerMenu:headerMenu});
        }
        //"Proposer" column should not be edited directly
        else if(headers[i] == "Proposer"){ 
            columnData.push({title:headers[i], field:headers[i], headerFilter:"input", width:"200", formatter:"textarea", headerMenu:headerMenu});
        }
        else{
            columnData.push({title:headers[i], field:headers[i], editor: "input", editable:true, headerFilter:"input", width:"200", formatter:"textarea", headerMenu:headerMenu});
        }
    }

    //Create the Tabulator table:
    var table = new Tabulator("#contentTable", {
        // tooltips:true, //example option (enable tooltips on all cells)
        groupToggleElement:"header",
        height:600,
        //height:"100%", //this makes the header not stay on the top..
        layout:"fitColumns",
        // pagination:"local",
        // paginationSize:"20",
        movableRows:false,
        groupBy:"Id",
        groupStartOpen:true,
        persistence:true,  //todo: add reset all functionality (button?), in case table is put in unusable state by user (very possible based on experience)     
        // movableRows:true,
        // responsiveLayout:"hide",
        keybindings:true,
        history:true, //records table interaction
        addRowPos:"bottom",
        // virtualDom:false,
        data: tableData,
        columns: columnData,
        reactiveData:true, //enables updating cell contents programmatically
         
        //todo: select all checkbox doesn't trigger rowSelected (no highlight, still deletes though...) - maybe it's just slow?
        rowSelected:function(row){
            row.getElement().style.backgroundColor = 'grey';
        },
        rowDeselected:function(row){
            row.getElement().style.backgroundColor = 'white';
        }, 
        // rowClick:function(e, row){ //trigger an alert message when the row is clicked
        // 	alert("Row " + row.getData().id + " Clicked!!!!");
        // },

        //cellClick:function(e, cell){
            // console.log(cell.getValue()); //this works
            //e - the click event object
            //cell - cell component
        //},
        cellEditing:function(cell){
            //now using check box to select rows         
            //var row = cell.getRow();
            //row.toggleSelect();
        },

        cellEdited:function(cell){
            cell.getElement().style.color = "#003399"; //change text colour on edited!
            var row = cell.getRow();
            var data = row.getData();
            var column = cell.getColumn();
            //var pos = row.getPosition(true); //row position from top, todo: is this needed?
            
            //update highlighting:
            if (data[curation_status] !== null) {
                if(data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(discussed.toLowerCase()) !== -1){
                    row.getElement().style.backgroundColor = 'moccasin'; //apply css change to row element
                }
                if(data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(ready.toLowerCase()) !== -1){
                    row.getElement().style.backgroundColor = 'palegreen'; //apply css change to row element
                }
                if(data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(proposed.toLowerCase()) !== -1){
                    row.getElement().style.backgroundColor = 'white'; //apply css change to row element
                }
            }
            //proposer column - check for loginName and auto fill:            
                var prevProposer = data[proposer];
                 
                if(prevProposer !== null){
                    var nameCheck = prevProposer.indexOf(loginName);
                    if(nameCheck > -1) {
                        //name exists, don't update
                    } else {
                        data[proposer] = prevProposer + "; " + loginName;
                    } 
                } else{
                    data[proposer] = loginName;
                }
                
                //text must be coloured if highlighting login set though..
                if(highlightLogin){ 
                var proposerA = data[proposer];
                if(proposerA !== null){
                    var nameCheckA = proposerA.indexOf(loginName);
                    if(nameCheckA > -1) {
                        row.getElement().style.color = 'red'; 
                    } 
                } 
            }
                //table.redraw(true); //not needed - redraws the whole table
                    //console.log("tableData Proposer is: "  + data[proposer]);
                    //todo: investigate the difference in tabulator between data[proposer] and tableData[pos].Proposer
                    //todo: is this going to affect saving the table?
        },

        //highlight on load table:
        rowFormatter:function(row){
            var data = row.getData();
            
                if (data[curation_status] !== null) {
                    if(data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(discussed.toLowerCase()) !== -1){
                        row.getElement().style.backgroundColor = 'moccasin'; //apply css change to row element
                    }
                    if(data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(ready.toLowerCase()) !== -1){
                        row.getElement().style.backgroundColor = 'palegreen'; //apply css change to row element
                    }
                    if(data[curation_status].toLowerCase().replace(/\s+/g, '').indexOf(proposed.toLowerCase()) !== -1){
                        row.getElement().style.backgroundColor = 'white'; //apply css change to row element
                    }
                }

            if(highlightLogin){ 
                var proposerA = data[proposer];
                if(proposerA !== null){
                    var nameCheckA = proposerA.indexOf(loginName);
                    if(nameCheckA > -1) {
                        row.getElement().style.color = 'red'; 
                    } 
                } 
            } else{
                    row.getElement().style.color = 'black'; 
                }
        },

        // rowUpdated:function(row){
        //is this for when row is updated on the back end?
        // },
    });

    //todo: FIX BUG - why is row added not accessible to tabulator functions (eg. can't add loginName in cellEdited())
    //new row button click handler:
    $("#add-row").click(function(){
        var newRowData = {};
        newRowData[curation_status] = "Proposed"
        table.addRow(newRowData);
    });

    //delete row button click handler:
    //todo: additional functionality needed: 
    // 1. if more than one row to be deleted, dialog says "Do you really want to delete these " + numberOfRowsSelected + "rows"
    // 2. if no rows selected, dialog says "No rows selected" and returns 
    $("#delete-row").click(function(){
        var selectedRows = table.getSelectedRows();
        if (confirm("Do you really want to delete this row?")) {
            table.deleteRow(selectedRows); 
        } else {
            //nothing
        }
    });

    $("#highlight-user").click(function(){
        highlightLogin = !highlightLogin;
        if(highlightLogin){
            this.children[0].style.color = "#FF0000";
        } else{
            this.children[0].style.color = "#333300";
        }
        table.redraw(true);
    });

    $('#contentTable').ready(function() {
    });

</script>

{% endblock %}
